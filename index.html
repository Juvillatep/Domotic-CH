<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domotic CH</title>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
            .then(() => console.log("Service Worker registrado"))
            .catch(error => console.log("Error registrando Service Worker", error));
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #007BFF; color: white; margin: 0; padding: 0; }
        .container { width: 90%; max-width: 400px; margin: auto; padding: 20px; }
        .btn { width: 100%; padding: 15px; margin: 10px 0; font-size: 18px; cursor: pointer; background-color: white; color: #007BFF; border: none; border-radius: 5px; }
        .btn:hover { background-color: #0056b3; color: white; }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        .grid-item { padding: 15px; background-color: white; color: #007BFF; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .grid-item.active { background-color: #0056b3; color: white; }
        .back-btn { margin-top: 20px; }
        @media (max-width: 600px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container" id="mainMenu">
        <h1>Domotic CH</h1>
        <button class="btn" onclick="irA('iluminacion')">Iluminación</button>
        <button class="btn" onclick="irA('alertas')">Alertas</button>
        <button class="btn" onclick="irA('cortinas')">Cortinas</button>
        <button class="btn" onclick="irA('sensores')">Sensores</button>
        <button class="btn" onclick="conectarBluetooth()">Conectar Bluetooth</button>
    </div>

    <div id="iluminacion" class="container" style="display:none;">
        <h2>Iluminación</h2>
        <div class="grid-container">
            <div class="grid-item" onclick="toggleLuz('habitacion1', this)">Habitación 1</div>
            <div class="grid-item" onclick="toggleLuz('habitacion2', this)">Habitación 2</div>
            <div class="grid-item" onclick="toggleLuz('cocina', this)">Cocina</div>
            <div class="grid-item" onclick="toggleLuz('estudio', this)">Estudio</div>
            <div class="grid-item" onclick="toggleLuz('bano', this)">Baño</div>
            <div class="grid-item" onclick="toggleLuz('todo', this)">Encender/Apagar Todo</div>
        </div>
        <button class="btn back-btn" onclick="volver()">Volver</button>
    </div>

    <div id="sensores" class="container" style="display:none;">
        <h2>Sensores</h2>
        <p>Aquí irá la información de los sensores.</p>
        <button class="btn back-btn" onclick="volver()">Volver</button>
    </div>

    <div id="alertas" class="container" style="display:none;">
        <h2>Alertas</h2>
        <p>Aquí aparecerán las alertas del sistema.</p>
        <button class="btn back-btn" onclick="volver()">Volver</button>
    </div>

    <script>
        let device, server, service, characteristic;
        let luces = {habitacion1: false, habitacion2: false, cocina: false, estudio: false, bano: false};

        function irA(seccion) {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById(seccion).style.display = "block";
        }

        function volver() {
            document.querySelectorAll(".container").forEach(el => el.style.display = "none");
            document.getElementById("mainMenu").style.display = "block";
        }

        function toggleLuz(id, elemento) {
            if (id === "todo") {
                // Verificar cuántas luces están encendidas
                let lucesEncendidas = Object.values(luces).filter(v => v).length;
                let nuevoEstado = lucesEncendidas < Object.keys(luces).length / 2; // Si la mayoría están apagadas, encender todo

                // Cambiar el estado de todas las luces
                for (let key in luces) {
                    luces[key] = nuevoEstado;
                    let luzElemento = document.querySelector(`.grid-item[onclick*="${key}"]`);
                    if (luzElemento) {
                        luzElemento.classList.toggle("active", nuevoEstado);
                    }
                }
            } else {
                // Encender o apagar una luz individual
                luces[id] = !luces[id];
                elemento.classList.toggle("active", luces[id]);
            }
    
            console.log("Estado de las luces:", luces);
        }
    
        async function conectarBluetooth() {
            try {
                console.log("Intentando conectar vía Bluetooth...");
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
                });
    
                server = await device.gatt.connect();
                console.log("Conectado a:", device.name);
    
                service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
    
                console.log("Servicio y característica obtenidos.");
                characteristic.addEventListener("characteristicvaluechanged", recibirDatos);
                await characteristic.startNotifications();
                console.log("Notificaciones activadas.");
    
                alert("¡Conectado a " + device.name + "!");
            } catch (error) {
                console.error("Error al conectar Bluetooth:", error);
                alert("Error al conectar Bluetooth.");
            }
        }
    </script>

</body>
</html>
